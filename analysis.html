<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boone Performance Analysis</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .analysis-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .week-selector { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center; }
        .week-selector select { padding: 8px; margin: 0 10px; border: 1px solid #ddd; border-radius: 4px; }
        
        /* Reuse styles from main page */
        .position-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .nav-btn {
            background: #34495e;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .nav-btn:hover, .nav-btn.active {
            background: #e74c3c;
        }
        
        .rankings-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }
        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
        }
        .table-content {
            max-height: 600px;
            overflow-y: auto;
        }
        .player-row {
            display: grid;
            grid-template-columns: 60px 1fr 120px 80px 100px;
            padding: 12px 20px;
            border-bottom: 1px solid #ecf0f1;
            align-items: center;
            transition: background-color 0.2s;
        }
        .player-row:hover {
            background-color: #f8f9fa;
        }
        .player-row:nth-child(even) {
            background-color: #fafafa;
        }
        .rank { font-weight: bold; color: #2c3e50; text-align: center; }
        .player-name { font-weight: 600; color: #2c3e50; }
        .opponent { color: #7f8c8d; font-size: 0.9em; }
        .actual-rank { text-align: center; font-weight: bold; }
        .difference { text-align: center; font-weight: bold; padding: 4px 8px; border-radius: 4px; }
        .difference.better { background: #d4edda; color: #155724; } /* Green for better performance */
        .difference.worse { background: #f8d7da; color: #721c24; } /* Red for worse performance */
        .difference.same { background: #e2e3e5; color: #383d41; } /* Gray for same */
        
        .export-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .btn { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .btn:hover { background: #2980b9; }
        .btn.secondary { background: #95a5a6; }
        .btn.secondary:hover { background: #7f8c8d; }
        
        .no-data { text-align: center; padding: 60px 20px; color: #7f8c8d; }
        .accuracy-summary { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        .accuracy-card { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            text-align: center; 
        }
        .accuracy-number { font-size: 2em; font-weight: bold; color: #3498db; }
        .accuracy-label { color: #7f8c8d; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="analysis-container">
        <header>
            <h1>üìä Boone Performance Analysis</h1>
            <p>Analyze weekly ranking accuracy vs final results</p>
            <nav>
                <a href="index.html" class="btn secondary">‚Üê Back to Current Rankings</a>
            </nav>
        </header>

        <div class="week-selector">
            <label for="week-select">Select Week to Analyze:</label>
            <select id="week-select" onchange="loadWeekAnalysis()">
                <option value="">Choose a week...</option>
            </select>
            <button class="btn" onclick="refreshWeekList()">üîÑ Refresh</button>
        </div>

        <div id="accuracy-summary-container" style="display: none;">
            <div class="accuracy-summary">
                <div class="accuracy-card">
                    <div class="accuracy-number" id="most-accurate-position">-</div>
                    <div class="accuracy-label">Most Accurate Position</div>
                </div>
                <div class="accuracy-card">
                    <div class="accuracy-number" id="least-accurate-position">-</div>
                    <div class="accuracy-label">Least Accurate Position</div>
                </div>
            </div>
        </div>

        <nav class="position-nav" id="analysis-nav" style="display: none;">
            <button class="nav-btn active" data-position="qb">QB</button>
            <button class="nav-btn" data-position="rb">RB</button>
            <button class="nav-btn" data-position="wr">WR</button>
            <button class="nav-btn" data-position="te">TE</button>
            <button class="nav-btn" data-position="flex">FLEX</button>
        </nav>

        <div id="analysis-tables-container"></div>

        <div id="no-data-message" class="no-data">
            <h3>Select a week to view analysis</h3>
            <p>Choose a week from the dropdown above to see Boone's ranking accuracy.</p>
            <p>You'll need both a weekly snapshot and final results for that week.</p>
        </div>

        <section class="export-section">
            <h2>üîß Analysis Tools (Coming Soon)</h2>
            <p>Once you have multiple weeks of data, these tools will be available:</p>
            <ul>
                <li><strong>Week-to-Week Comparison:</strong> See how rankings change over time</li>
                <li><strong>Final Results Analysis:</strong> Compare pre-game rankings to actual performance</li>
                <li><strong>CSV Export:</strong> Export data for external analysis</li>
                <li><strong>Accuracy Metrics:</strong> Track Boone's prediction accuracy</li>
            </ul>
            
            <div style="margin-top: 20px;">
                <button class="btn" onclick="exportCurrentWeek()" disabled>Export Current Week</button>
                <button class="btn" onclick="exportSeasonData()" disabled>Export Season Data</button>
                <button class="btn" onclick="generateReport()" disabled>Generate Report</button>
            </div>
        </section>
    </div>

    <script>
        let availableWeeks = [];
        let currentWeekData = null;
        let currentAnalysis = null;

        // Load available weeks on page load
        async function loadAvailableWeeks() {
            try {
                const response = await fetch('data/archive.json');
                const archive = await response.json();
                availableWeeks = archive.snapshots;
                populateWeekDropdown();
            } catch (error) {
                console.log('No snapshots available yet');
            }
        }

        function populateWeekDropdown() {
            const select = document.getElementById('week-select');
            select.innerHTML = '<option value="">Choose a week...</option>';
            
            availableWeeks.forEach(snapshot => {
                const option = document.createElement('option');
                option.value = `${snapshot.week}-${snapshot.year}`;
                option.textContent = `Week ${snapshot.week}, ${snapshot.year}`;
                select.appendChild(option);
            });
        }

        function refreshWeekList() {
            loadAvailableWeeks();
        }

        async function loadWeekAnalysis() {
            const select = document.getElementById('week-select');
            const selectedValue = select.value;
            
            if (!selectedValue) {
                showNoDataMessage();
                return;
            }

            const [week, year] = selectedValue.split('-');
            
            try {
                // Load snapshot data
                const snapshotResponse = await fetch(`data/snapshots/${year}/week-${week}.json`);
                const snapshot = await snapshotResponse.json();
                
                // Try to load final results
                const resultsResponse = await fetch(`data/analysis/final-results-week-${week}-${year}.json`);
                
                if (!resultsResponse.ok) {
                    showNoResultsMessage(week, year);
                    return;
                }
                
                const results = await resultsResponse.json();
                currentWeekData = { snapshot, results, week, year };
                
                // Calculate analysis
                currentAnalysis = calculateWeekAnalysis(snapshot.data, results);
                
                // Show the analysis
                displayWeekAnalysis();
                
            } catch (error) {
                console.error('Error loading analysis:', error);
                showErrorMessage(week, year);
            }
        }

        function calculateWeekAnalysis(rankings, results) {
            const analysis = {
                positions: {},
                positionAccuracy: {},
                summary: {
                    mostAccuratePosition: null,
                    leastAccuratePosition: null
                }
            };

            // First, organize players by position and calculate position-specific ranks
            const playersByPosition = {};
            const positions = ['qb', 'rb', 'wr', 'te'];

            positions.forEach(pos => {
                if (rankings[pos]) {
                    // Get all players from this position who have results
                    const playersWithResults = rankings[pos]
                        .map(player => ({
                            ...player,
                            result: results.players[player.player]
                        }))
                        .filter(player => player.result);
                    
                    // Sort by fantasy points to get position-specific actual ranks
                    playersWithResults.sort((a, b) => b.result.fantasyPoints - a.result.fantasyPoints);
                    
                    // Assign position-specific actual ranks
                    playersWithResults.forEach((player, index) => {
                        player.positionActualRank = index + 1;
                    });
                    
                    playersByPosition[pos] = playersWithResults;
                }
            });

            // Now calculate differences using position-specific ranks
            positions.forEach(pos => {
                if (playersByPosition[pos]) {
                    const posAnalysis = [];
                    const positionDifferences = [];
                    
                    playersByPosition[pos].forEach(player => {
                        const difference = player.preGameRank - player.positionActualRank; // Positive = player did better than expected
                        const absDifference = Math.abs(difference);
                        
                        const playerAnalysis = {
                            name: player.player,
                            opponent: player.opponent,
                            preGameRank: player.preGameRank,
                            actualRank: player.positionActualRank, // Position-specific rank
                            overallActualRank: player.result.actualRank, // Overall rank for reference
                            fantasyPoints: player.result.fantasyPoints,
                            difference: difference,
                            absDifference: absDifference
                        };
                        
                        posAnalysis.push(playerAnalysis);
                        positionDifferences.push(absDifference);
                    });
                    
                    analysis.positions[pos] = posAnalysis;
                    
                    // Calculate position accuracy (lower average difference = more accurate)
                    if (positionDifferences.length > 0) {
                        const avgDifference = positionDifferences.reduce((a, b) => a + b, 0) / positionDifferences.length;
                        // Convert to accuracy percentage based on position size
                        const positionSize = rankings[pos].length;
                        const accuracyPercentage = Math.max(0, Math.round(100 - (avgDifference / positionSize) * 100 * 2));
                        
                        analysis.positionAccuracy[pos] = {
                            avgDifference: avgDifference,
                            accuracyPercentage: accuracyPercentage,
                            playersAnalyzed: positionDifferences.length,
                            positionSize: positionSize
                        };
                    }
                }
            });

            // Find most and least accurate positions
            const posAccuracies = Object.entries(analysis.positionAccuracy);
            if (posAccuracies.length > 0) {
                posAccuracies.sort((a, b) => b[1].accuracyPercentage - a[1].accuracyPercentage);
                
                const mostAccurate = posAccuracies[0];
                const leastAccurate = posAccuracies[posAccuracies.length - 1];
                
                analysis.summary.mostAccuratePosition = {
                    position: mostAccurate[0].toUpperCase(),
                    accuracy: mostAccurate[1].accuracyPercentage,
                    avgDifference: mostAccurate[1].avgDifference.toFixed(1)
                };
                
                analysis.summary.leastAccuratePosition = {
                    position: leastAccurate[0].toUpperCase(),
                    accuracy: leastAccurate[1].accuracyPercentage,
                    avgDifference: leastAccurate[1].avgDifference.toFixed(1)
                };
            }

            return analysis;
        }

        function displayWeekAnalysis() {
            // Show summary cards
            document.getElementById('accuracy-summary-container').style.display = 'block';
            
            if (currentAnalysis.summary.mostAccuratePosition) {
                document.getElementById('most-accurate-position').innerHTML = 
                    `${currentAnalysis.summary.mostAccuratePosition.position}<br><span style="font-size: 0.7em; color: #7f8c8d;">${currentAnalysis.summary.mostAccuratePosition.accuracy}% accuracy</span>`;
            }
            
            if (currentAnalysis.summary.leastAccuratePosition) {
                document.getElementById('least-accurate-position').innerHTML = 
                    `${currentAnalysis.summary.leastAccuratePosition.position}<br><span style="font-size: 0.7em; color: #7f8c8d;">${currentAnalysis.summary.leastAccuratePosition.accuracy}% accuracy</span>`;
            }

            // Show position navigation
            document.getElementById('analysis-nav').style.display = 'flex';
            
            // Hide no-data message
            document.getElementById('no-data-message').style.display = 'none';
            
            // Setup position navigation
            setupPositionNavigation();
            
            // Show first position by default
            showPositionAnalysis('qb');
        }

        function setupPositionNavigation() {
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all buttons
                    navButtons.forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    btn.classList.add('active');
                    // Show the selected position
                    showPositionAnalysis(btn.dataset.position);
                });
            });
        }

        function showPositionAnalysis(position) {
            const container = document.getElementById('analysis-tables-container');
            const positionData = currentAnalysis.positions[position];
            
            if (!positionData || positionData.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>No data available for ${position.toUpperCase()}</h3>
                        <p>No final results found for this position.</p>
                    </div>
                `;
                return;
            }

            // Sort by pre-game rank
            positionData.sort((a, b) => a.preGameRank - b.preGameRank);

            let tableHTML = `
                <div class="rankings-table">
                    <div class="table-header">
                        <h2>${position.toUpperCase()} - Week ${currentWeekData.week} Analysis</h2>
                    </div>
                    <div class="table-content">
                        <div class="player-row" style="font-weight: bold; background: #f8f9fa;">
                            <div class="rank">Pred Rank</div>
                            <div class="player-name">Player</div>
                            <div class="opponent">Opponent</div>
                            <div class="actual-rank">Act Rank</div>
                            <div class="difference">Difference</div>
                        </div>
            `;

            positionData.forEach(player => {
                const diffClass = player.difference > 0 ? 'better' : (player.difference < 0 ? 'worse' : 'same');
                const diffText = player.difference > 0 ? `+${player.difference}` : player.difference.toString();
                
                tableHTML += `
                    <div class="player-row">
                        <div class="rank">${player.preGameRank}</div>
                        <div class="player-name">${player.name}</div>
                        <div class="opponent">${player.opponent}</div>
                        <div class="actual-rank">${player.actualRank}</div>
                        <div class="difference ${diffClass}">${diffText}</div>
                    </div>
                `;
            });

            tableHTML += `
                    </div>
                </div>
            `;

            container.innerHTML = tableHTML;
        }

        function showNoDataMessage() {
            document.getElementById('accuracy-summary-container').style.display = 'none';
            document.getElementById('analysis-nav').style.display = 'none';
            document.getElementById('analysis-tables-container').innerHTML = '';
            document.getElementById('no-data-message').style.display = 'block';
        }

        function showNoResultsMessage(week, year) {
            document.getElementById('no-data-message').innerHTML = `
                <h3>No results data for Week ${week}, ${year}</h3>
                <p>You have a snapshot for this week, but no final results yet.</p>
                <p>Upload final results using the CSV converter or results entry tool.</p>
            `;
            document.getElementById('no-data-message').style.display = 'block';
        }

        function showErrorMessage(week, year) {
            document.getElementById('no-data-message').innerHTML = `
                <h3>Error loading Week ${week}, ${year}</h3>
                <p>Could not load snapshot or results data.</p>
                <p>Make sure both files exist and are properly formatted.</p>
            `;
            document.getElementById('no-data-message').style.display = 'block';
        }

        function exportCurrentWeek() {
            if (!currentWeekData) {
                alert('Please select a week first');
                return;
            }
            // Implementation for CSV export
            alert('CSV export feature coming soon!');
        }

        function exportSeasonData() {
            alert('Season export will be available once multiple weeks are captured');
        }

        function generateReport() {
            alert('Analysis reports will be generated once final results are integrated');
        }

        // Load available weeks on page load
        loadAvailableWeeks();
    </script>
</body>
</html>